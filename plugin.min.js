!function(){var t=tinymce.DOM,e=tinymce.dom.DomQuery,n=tinymce.each,i="materialCitation",o=tinymce.dom.Event,a=tinymce.dom.EventUtils;tinymce.create("tinymce.plugins.Citation",{getInfo:function(){return{longname:"Citation Plugin",author:"Schuyler Duveen",authorurl:"http://ctl.columbia.edu/",infourl:"http://mediathread.info/",version:"1.2"}},createCitationHTML:function(t){var e=' <a href="'+t.annotation+'" class="'+i;return t.type&&(e+=" asset-"+t.type),0===t.range1&&(e+=" asset-whole"),e+='">'+decodeURI(t.title)+"</a> "},addCitation:function(t){t=t?t:window.event;var e=t.target||t.srcElement,n=this.decodeCitation(e);if(n){var i=this.createCitationHTML(n);tinymce.execCommand("mceInsertContent",!1,i)}},decodeCitation:function(t){var e=!1,i=String(t.src).match(/#(annotation=.+)$/);if(null!==i){e={};var o=i[1].replace(/\+/g,"%20").split(/\&amp\;|\&\#38\;|\&#x26;|\&/);n(o,function(t){var n=t.split("="),i=n.shift();e[i]=n.join("=")}),e.title=e.title.replace(/([ -])0:/g,"$1").replace(/([ -])0/g,"$1")}else{var a=t.getAttribute("name"),r=t.getAttribute("title");r&&a&&(e={annotation:a,title:r})}return e},_decorateCitationAdders:function(o,r,c){var s=null;n(t.select("img."+i,c),function(t){e(t).hasClass("clickableCitation")&&(t.onclick=function(t){r.addCitation(t)})},this),a.bind(document.body,"mouseover",function(e){null!==s&&(t.remove(s),s=null)})},init:function(n,a){var r=this;n.onChange.add(this._onChange,this),this.newStyle=!1,this.legacy=!0,"function"==typeof tinymce.plugins.EditorWindow&&(this.newStyle=!0,r._decorateCitationAdders(n,r,document),r.decorateCitationAdders=function(t){r._decorateCitationAdders(n,r,t)},n.onInit.add(function(n){n.dom.loadCSS(a+"/css/citation.css");var c=n.getDoc().documentElement;tinymce.dom.EventUtils.bind(c,"dragover",function(t){t.preventDefault()}),tinymce.dom.EventUtils.bind(c,"drop",function(t){if(setTimeout(function(){r._onChange(n)},50),t.preventDefault(),!/Firefox\/3/.test(navigator.userAgent)){var e=t.target,i=String(t.dataTransfer.getData("Text")),o=n.dom.create("img",{src:i});tinymce.isIE&&(e=n.selection.getStart()),e.parentNode.insertBefore(o,e)}}),"function"==typeof n.addCursorWindow&&n.addCursorWindow({name:"citation",test:function(e){var n=t.getParent(e,"A."+i);return n&&!n.name?n:void 0},onUnload:function(t){r.current_opener&&(o.unbind(r.current_opener,"click",r.opener_listener),r.asset_target=null),r.citation&&r.citation.onUnload&&(r.citation.onUnload(),r.citation=null)},content:function(n){var i=String(n.href),o=t.create("div",{},'<a href="'+i+'">View Selection</a><div class="asset-object"><div class="assetbox" style="width: 322px; display:none;"><div class="asset-display"></div><div class="clipstrip-display"></div></div></div>');return r.opener_listener=e(o.firstChild).on("click",function(t){t.preventDefault();var e=new CitationView;e.init({autoplay:!0,targets:{asset:r.asset_target}}),r.citation=e.openCitation(n)}),r.current_opener=o.firstChild,r.asset_target=o.lastChild.firstChild,o}})}))},_onChange:function(t,e,o){var a=t.getDoc();"function"==typeof wordCount&&wordCount();var r=!1;n(t.dom.select("img"),function(e){var n=this.decodeCitation(e);n&&("h2"===e.parentNode.parentNode.tagName.toLowerCase()&&/asset/.test(e.parentNode.parentNode.className)&&(e=e.parentNode.parentNode),t.dom.replace(t.dom.create("span",null,this.createCitationHTML(n)),e),r=!0)},this),this.legacy&&n(t.dom.select("input."+i),function(t){var e;if("object"==typeof t.nextSibling&&(null===t.nextSibling||3===t.nextSibling.nodeType&&(e=t.nextSibling.textContent,(""===e||" "===e)&&(t.nextSibling.nodeValue=" "))),"object"==typeof t.previousSibling)if(null===t.previousSibling){var n=t.parentNode;n.insertBefore(a.createTextNode(" "),t)}else 3===t.previousSibling.nodeType&&(e=t.previousSibling.textContent,(""===e||" "===e)&&(t.previousSibling.nodeValue=" "))},this),r&&t.nodeChanged()}}),tinymce.PluginManager.add("citation",tinymce.plugins.Citation)}();
